"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2462],{62462:function(e,t,r){r.d(t,{Z:function(){return C}});var a=r(52676),o=r(75271),i=r(44754),n=r(62935),s=r(78406),c=r(57338),d=r(56447),l=r(56795),u=r(17831),p=r(81090),m=r(61271),h=r(57598),S=r(65893),g=r(22532),y=r(25822),f=r(21461),x=r(35019),v=r(53785),Z=r(79481),b=r(71137),j=r(85464),_=r(660);function C(e){let{open:t,onClose:r,onSelectCharacter:C}=e,[P,I]=(0,o.useState)(0),[E,w]=(0,o.useState)(""),U=(0,j.Z)(E,{wait:500}),[k,D]=(0,o.useState)(""),L=(0,j.Z)(k,{wait:300}),[M,F]=(0,o.useState)(null),{data:A,isLoading:R,error:G}=(0,_.Q_)(t&&0===P),{data:V,isLoading:W,error:K}=(0,_.jt)(t&&1===P),{data:N,isLoading:z,mutate:B,reset:T}=(0,_.b2)(e=>{F(e)});(0,o.useEffect)(()=>{2===P&&U.trim()?B(U.trim()):2===P&&(F(null),T())},[U,P,B,T]);let $=e=>{F(e)},q=()=>{r(),I(0),w(""),D(""),F(null),T()},Q=(e,t)=>{if(!e)return[];if(!t.trim())return e;let r=t.toLowerCase();return e.filter(e=>{var t;return(null===(t=e.model_name)||void 0===t?void 0:t.toLowerCase().includes(r))||e.id.toLowerCase().includes(r)})},H=(e,t,r)=>{if(t)return(0,a.jsx)(i.Z,{sx:{display:"block",margin:"auto",my:2}});if(r)return(0,a.jsxs)(n.Z,{color:"error",sx:{mt:2},children:["Error loading characters: ",r.message]});let o=Q(e,L);return o&&0!==o.length?(0,a.jsx)(s.Z,{sx:{overflowY:"auto",pt:0},children:o.map(e=>(0,a.jsx)(c.ZP,{disablePadding:!0,secondaryAction:(null==M?void 0:M.id)===e.id?(0,a.jsx)(n.Z,{variant:"caption",color:"primary",children:"Selected"}):null,children:(0,a.jsxs)(d.Z,{onClick:()=>$(e),selected:(null==M?void 0:M.id)===e.id,children:[(0,a.jsx)(l.Z,{children:(0,a.jsx)(u.Z,{src:e.image_url||void 0,alt:e.model_name||""})}),(0,a.jsx)(p.Z,{primary:e.model_name,secondary:e.id,primaryTypographyProps:{noWrap:!0},secondaryTypographyProps:{noWrap:!0,fontSize:"0.75rem"}})]})},e.id))}):(0,a.jsx)(n.Z,{sx:{mt:2},children:"No characters found."})};return(0,a.jsxs)(m.Z,{open:t,onClose:q,maxWidth:"sm",fullWidth:!0,children:[(0,a.jsxs)(h.Z,{dividers:!0,sx:{height:"600px",p:0,overflowY:"auto"},children:[(0,a.jsxs)(S.Z,{sx:{position:"sticky",top:0,zIndex:1,bgcolor:"background.paper",pt:2,pl:3,pr:3,pb:0===P||1===P?1:0},children:[(0,a.jsx)(S.Z,{sx:{borderBottom:1,borderColor:"divider"},children:(0,a.jsxs)(g.Z,{value:P,onChange:(e,t)=>{I(t),w(""),F(null),T(),D("")},"aria-label":"Character selection tabs",children:[(0,a.jsx)(y.Z,{label:"My Characters"}),(0,a.jsx)(y.Z,{label:"Premade"}),(0,a.jsx)(y.Z,{label:"Choose by ID"})]})}),(0===P||1===P)&&(0,a.jsx)(f.Z,{label:"Filter by Name or ID",variant:"outlined",fullWidth:!0,size:"small",value:k,onChange:e=>D(e.target.value),sx:{mt:2}})]}),(0,a.jsxs)(S.Z,{sx:{pl:3,pr:3,pb:3},children:[0===P&&H(A,R,G),1===P&&H(V,W,K),2===P&&(0,a.jsxs)(x.Z,{spacing:2,sx:{mt:2},children:[(0,a.jsx)(f.Z,{label:"Character Model ID",variant:"outlined",fullWidth:!0,value:E,onChange:e=>w(e.target.value),InputProps:{endAdornment:(0,a.jsx)(v.Z,{position:"end",children:z?(0,a.jsx)(i.Z,{size:20}):null})}}),z?(0,a.jsx)(i.Z,{sx:{display:"block",margin:"auto",my:2}}):N?(0,a.jsx)(s.Z,{sx:{pt:0},children:(0,a.jsx)(c.ZP,{disablePadding:!0,secondaryAction:(0,a.jsx)(n.Z,{variant:"caption",color:"primary",children:"Selected"}),children:(0,a.jsxs)(d.Z,{onClick:()=>$(N),selected:(null==M?void 0:M.id)===N.id,children:[(0,a.jsx)(l.Z,{children:(0,a.jsx)(u.Z,{src:N.image_url||void 0,alt:N.model_name||""})}),(0,a.jsx)(p.Z,{primary:N.model_name,secondary:N.id,primaryTypographyProps:{noWrap:!0},secondaryTypographyProps:{noWrap:!0,fontSize:"0.75rem"}})]})},N.id)}):U.trim()&&!z&&(0,a.jsx)(n.Z,{children:"Character not found or is not a valid character model."})]})]})]}),(0,a.jsxs)(Z.Z,{children:[(0,a.jsx)(b.Z,{onClick:q,children:"Cancel"}),(0,a.jsx)(b.Z,{onClick:()=>{C(M),r()},variant:"contained",disabled:!M,children:"Confirm Selection"})]})]})}},660:function(e,t,r){r.d(t,{HX:function(){return p},Q_:function(){return v},V4:function(){return u},b2:function(){return b},jt:function(){return Z},m9:function(){return h},mP:function(){return l},w1:function(){return S}});var a=r(21964),o=r(13200),i=r(68836),n=r.n(i),s=r(40902),c=r(28337),d=r(30754);function l(){let e=(0,s.ZP)(e=>e.updateShotVideoStatus),t=(0,s.ZP)(e=>e.videoGenerationMethod);return(0,a.D)({mutationFn:async e=>{let r=e.videoGenerationMethod||t,{data:a}=await n().post("/api/internal/storybuilder/generate_video",{...e,videoGenerationMethod:r});return a},onMutate:t=>(e(t.shotId,"generating"),{shotId:t.shotId}),onSuccess:(t,r)=>{e(r.shotId,"success",t.videoUrl)},onError:(t,r)=>{console.error(`Video generation failed for shot ${r.shotId}:`,t.message),e(r.shotId,"error")}})}function u(){let e=(0,s.ZP)(e=>e.updateShotImageStatus),t=(0,s.ZP)(e=>e.includeCharacterStyle);return(0,a.D)({mutationFn:async e=>{let{shot:r,recurringProps:a,imageGenerationMethod:o,aspectRatio:i,selectedCharacter:s,selectedCharacterSampleImage:c}=e,d={prompt:r.imagePrompt,recurringProps:a,imageGenerationMethod:o,aspectRatio:i,selectedCharacter:s,selectedCharacterSampleImage:c,includeCharacterStyle:t},l=await n().post("/api/internal/storybuilder/generate_image",d);return{shotId:r.id,data:l.data}},onMutate:t=>{let{shot:r}=t;e(r.id,"generating")},onSuccess:t=>{t.data.imageUrl?e(t.shotId,"success",t.data.imageUrl):(console.error("API success but no image URL received for shot:",t.shotId),e(t.shotId,"error"))},onError:(t,r)=>{let{shot:a}=r;console.error(`Error generating image for Shot ${a.id}:`,t),e(a.id,"error")}})}function p(e){let{setScriptLoading:t,setScript:r}=s.ZP.getState(),o=(0,s.ZP)(e=>e.scriptSchemaDescriptions);return(0,a.D)({mutationFn:async e=>(await n().post("/api/internal/storybuilder/generate_script",{...e,scriptSchemaDescriptions:o})).data,onMutate:()=>{t(!0)},onSuccess:t=>{t.script&&(r(t.script),e(t.script))},onError:e=>{console.error("Error generating script:",e)},onSettled:()=>{t(!1)}})}let m=e=>{let t=e.replaceAll(/\s+/g,"_").replaceAll(/[^\w.]/g,""),r=t.length>100?t.slice(0,100):t;return`${r||"storybuilder_export"}.mp4`};function h(){let e=(0,s.ZP)(e=>e.oneSentenceStory);return(0,a.D)({mutationFn:async e=>(await n().post("/api/internal/storybuilder/export_video",e,{responseType:"blob",timeout:187e4})).data,onSuccess:t=>{(0,d.t5)("Video export successful. Starting download...");let r=window.URL.createObjectURL(t),a=document.createElement("a");a.href=r;let o=m(e||"storybuilder_export");a.setAttribute("download",o),document.body.append(a),a.click(),a.remove(),window.URL.revokeObjectURL(r)},onError:e=>{console.error("Video export failed:",e),(0,d.cB)("Video export failed. Please try again.")}})}function S(){return(0,a.D)({mutationFn:async e=>{let t=new FormData;t.append("file",e),t.append("cdnFolder","internal/storybuilder/soundtracks");let{data:r}=await c.ZP.post("/media/upload_file",t,{headers:{"Content-Type":"multipart/form-data"}});return r},onError:e=>{console.error("Failed to upload soundtrack:",e),(0,d.cB)("Failed to upload soundtrack. Please try again.")}})}let g=e=>(e||[]).map(e=>({id:e.id,model_name:e.model_name,image_url:e.image_url,fal_cdn_file_path:e.fal_cdn_file_path,object_prompt:e.object_prompt,character_features_description:e.character_features_description,sample_images:e.sample_images})),y=async()=>{let{data:e}=await n().get("/api/character/models");return g(e.data)},f=async()=>{let{data:e}=await n().get("/api/character/premade");return g(e.data)},x=async e=>{if(!e)return null;try{let{data:t}=await n().get(`/api/train/model?id=${e}`);if(t.data)return g([t.data])[0];return null}catch(e){return console.error("Error fetching character by ID:",e),null}};function v(e){return(0,o.a)({queryKey:["internal:userCharacters"],queryFn:y,enabled:e})}function Z(e){return(0,o.a)({queryKey:["internal:premadeCharacters"],queryFn:f,enabled:e})}function b(e){return(0,a.D)({mutationFn:x,onSuccess:t=>{e(t)}})}},40902:function(e,t,r){r.d(t,{ER:function(){return l}});var a=r(67197),o=r(2345),i=r(52973),n=r(47469),s=r(30174);let c={systemPromptKey:s.x0,customSystemPrompt:s.dH,scriptSchemaDescriptions:s.BK,aspectRatio:"16:9",scriptModel:"o4-mini",characterStyle:"",characterSpecies:"",oneSentenceStory:"",numShots:[5,10],selectedCharacter:null,selectedCharacterSampleImage:null,script:{title:"",recurringProps:[],shots:[]},imageGenerationMethod:"fluxlora",videoGenerationMethod:"pixverse_4_720p",includeCharacterStyle:!0,videoUrl:void 0,soundtrackUrl:null,selectedShotId:void 0,playbackSpeed:2,isScriptLoading:!1,scriptError:void 0,isImageLoading:!1,imageError:void 0,isExporting:!1,exportError:void 0,setSelectedCharacter:()=>{},setSelectedCharacterSampleImage:()=>{}},d=(0,o.U)()((0,i.mW)((0,n.n)((e,t)=>({...c,setScriptSchemaDescription:(t,r)=>e(e=>{e.scriptSchemaDescriptions[t]=r}),setSystemPromptKey:t=>e(e=>{switch(e.systemPromptKey=t,t){case s.x0:e.customSystemPrompt=s.dH,e.scriptSchemaDescriptions=s.BK,e.numShots=[5,10];break;case s.NN:e.customSystemPrompt=s.sQ,e.scriptSchemaDescriptions=s.Q9,e.numShots=5;break;case s.r_:e.customSystemPrompt=s.ci,e.scriptSchemaDescriptions=s.E$,e.numShots=5;break;case s.S8:e.customSystemPrompt=s.zh,e.scriptSchemaDescriptions=s.ym,e.numShots=5}}),setCustomSystemPrompt:t=>e(e=>{e.customSystemPrompt=t}),setAspectRatio:t=>e(e=>{e.aspectRatio=t}),setScriptModel:t=>e(e=>{e.scriptModel=t}),setCharacterStyle:t=>e(e=>{e.characterStyle=t}),setCharacterSpecies:t=>e(e=>{e.characterSpecies=t}),setOneSentenceStory:t=>e(e=>{e.oneSentenceStory=t}),setNumShots:t=>e(e=>{e.numShots=t}),setSelectedCharacter:t=>e(e=>{e.selectedCharacter=t}),setSelectedCharacterSampleImage:t=>e(e=>{e.selectedCharacterSampleImage=t}),setScript:t=>e(e=>{e.isScriptLoading=!1,e.scriptError=void 0;let r=(t.shots||[]).map(e=>({...e,id:e.id||(0,a.x0)(),imageUrl:e.imageUrl||void 0,imageStatus:e.imageStatus||"idle",videoUrl:e.videoUrl||void 0,videoStatus:e.videoStatus||"idle"}));e.script={...e.script,id:t.id||e.script.id,recurringProps:t.recurringProps||[],shots:r}}),setShots:t=>e(e=>{e.script.shots=t}),updateShotPrompt:(t,r,a)=>e(e=>{let o=e.script.shots.find(e=>e.id===t);o&&(o[r]=a)}),updateShotImageStatus:(t,r,a)=>e(e=>{let o=e.script.shots.find(e=>e.id===t);o&&(o.imageStatus=r,void 0!==a&&(o.imageUrl=a))}),setImageGenerationMethod:t=>e(e=>{e.imageGenerationMethod=t}),setVideoGenerationMethod:t=>e(e=>{e.videoGenerationMethod=t}),setIncludeCharacterStyle:t=>e(e=>{e.includeCharacterStyle=t}),setAllImagesLoading:t=>e(e=>{e.isImageLoading=t,e.imageError=void 0,t&&e.script.shots.forEach(e=>{e.imageStatus="generating"})}),setAllImagesResult:(t,r)=>e(e=>{e.isImageLoading=!1,e.imageError=r,t.forEach(t=>{let r=e.script.shots.find(e=>e.id===t.shotId);r&&(r.imageUrl=t.imageUrl??r.imageUrl,r.imageStatus=t.error?"error":t.imageUrl?"success":"idle",r.videoStatus="idle",r.videoUrl=void 0)})}),updateShotVideoStatus:(t,r,a)=>e(e=>{let o=e.script.shots.find(e=>e.id===t);o&&(o.videoStatus=r,void 0!==a&&(o.videoUrl=a),("error"===r||"idle"===r||"generating"===r&&void 0===a)&&(o.videoUrl=void 0))}),setVideoUrl:t=>e(e=>{e.videoUrl=t}),setSoundtrackUrl:t=>e(e=>{e.soundtrackUrl=t}),setSelectedShotId:t=>e(e=>{e.selectedShotId=t}),setPlaybackSpeed:t=>e(e=>{e.playbackSpeed=t}),setScriptLoading:(t,r)=>e(e=>{e.isScriptLoading=t,e.scriptError=r}),setExporting:(t,r)=>e(e=>{e.isExporting=t,e.exportError=r}),resetStore:()=>e(c),resetState:()=>e(c)})),{name:"storyBuilderStore"}));t.ZP=d;let l=e=>!!e.oneSentenceStory.trim()}}]);